extends layout

block styles
  link(rel="stylesheet", href="/stylesheets/index.css")

block content
  .container-fluid.mt-4
    // CATEGORIAS NO TOPO
    .categorias-topo.bg-white.rounded-3.shadow-sm.p-3.mb-3
      if categorias && categorias.length
        h6.text-success.mb-3.text-center Categorias
        .d-flex.mb-2#categorias-linha
        if categorias.length > 0
          a#link-visualizar-todas-categorias(href="javascript:void(0)", style="color:#009e60; text-decoration:underline; font-weight:500; margin-left:8px;") Visualizar todas
        .categorias-side-panel.position-fixed.top-0.start-0.bg-white.shadow-lg.p-3(style="display:none;z-index:999;height:100vh;width:320px;overflow-y:auto;")
          .d-flex.justify-content-between.align-items-center.mb-3
            h5.mb-0.text-success Categorias
            a#link-fechar-categorias(href="javascript:void(0)", style="color:#d9534f; text-decoration:underline; font-weight:500;") Fechar
          each categoria in categorias
            button.categoria-btn.mb-2.acao-restrita(
              type='button',
              data-categoria=categoria.id_categoria
            )= categoria.nome_categoria
      else
        p.text-center.text-muted Nenhuma categoria encontrada.

    if tags && tags.length
      .tags-topo.bg-white.rounded-3.shadow-sm.p-3.mb-3
        h6.text-primary.mb-3.text-center Tags Populares
        .d-flex.mb-2#tags-linha
        if tags.length > 0
          a#link-visualizar-todas-tags(href="javascript:void(0)", style="color:#007bff; text-decoration:underline; font-weight:500; margin-left:8px;") Visualizar todas
        .tags-side-panel.position-fixed.top-0.start-0.bg-white.shadow-lg.p-3(style="display:none;z-index:999;height:100vh;width:320px;overflow-y:auto;")
          .d-flex.justify-content-between.align-items-center.mb-3
            h5.mb-0.text-primary Tags
            a#link-fechar-tags(href="javascript:void(0)", style="color:#d9534f; text-decoration:underline; font-weight:500;") Fechar
          each tag in tags
            - if (tag.id_tag)
              - const traducao = tag.traducoes && tag.traducoes[0];
              button.tag-btn.mb-2.acao-restrita(
                type='button',
                data-tag=tag.id_tag
              )= traducao ? traducao.nome_tag : (tag.nome_tag || tag.nome)

    // FEED DE POSTAGENS
    .row.justify-content-center
      .col-12.col-md-8.col-lg-7#feed-postagens(style="max-width:58vw;")
        if posts && posts.length
          each post in posts
            .card.shadow-sm.post-card.mb-4(style="cursor:pointer;" data-id=post.id_postagem)
              .card-body.d-flex.flex-column 
                // Foto do autor
                if post.autor
                  if post.autor.foto_perfil
                    if usuario && post.autor.id_usuario == usuario.id_usuario
                      a(href=gerarUrlPerfilProprio(post.autor.id_usuario))
                        img.rounded-circle.me-3(src=post.autor.foto_perfil, alt=post.autor.nome_usuario, width="48", height="48", onerror="this.src='/images/default-user.png'")
                    else
                      a(href=gerarUrlPerfilOutro(post.autor.id_usuario))
                        img.rounded-circle.me-3(src=post.autor.foto_perfil, alt=post.autor.nome_usuario, width="48", height="48", onerror="this.src='/images/default-user.png'")
                h5.card-title= post.titulo || 'Sem título'
                p.card-text.text-truncate= post.resumo || 'Sem resumo'
                // DADOS DE CRIAÇÃO/ATUALIZAÇÃO/Autor ANTES DA IMAGEM
                small.text-muted.mb-2
                  | Criado em: #{post.data_criacao ? (post.data_criacao.toLocaleString ? post.data_criacao.toLocaleString() : post.data_criacao) : 'N/A'}
                  br
                  | Atualizado em: #{post.data_atualizacao ? (post.data_atualizacao.toLocaleString ? post.data_atualizacao.toLocaleString() : post.data_atualizacao) : 'N/A'}
                  br
                  | Autor: #{post.autor ? post.autor.nome_usuario : 'Desconhecido'}
                // IMAGEM DA POSTAGEM EM LINHA SEPARADA
                if post.url_midia
                  .w-100.mb-2
                    img.img-fluid.d-block.mx-auto(src=post.url_midia, alt="Imagem da postagem", style="max-width:100%;height:auto;", onerror="this.src='/images/default-post.png'")
                if isLoggedIn
                  .mt-2
                    button.btn.btn-outline-success.btn-sm.acao-restrita(type="button")
                      i.fas.fa-heart.me-1
                      | Curtir
                    span.ms-2
                      i.fas.fa-heart.me-1
                      | #{post.curtidas || 0} curtidas
                    span.ms-2
                      i.fas.fa-eye.me-1
                      | #{post.visualizacoes || 0} visualizações
                else
                  .mt-2
                    button.btn.btn-outline-success.btn-sm.acao-restrita(type="button")
                      i.fas.fa-heart.me-1
                      | Curtir
                    span.ms-2
                      i.fas.fa-heart.me-1
                      | #{post.curtidas || 0} curtidas
                    span.ms-2
                      i.fas.fa-eye.me-1
                      | #{post.visualizacoes || 0} visualizações
        else
          .alert.alert-info.text-center.mt-4 Não há postagens para exibir.

    // MODAL DE POSTAGEM
    .modal.fade#modalPostagem(tabindex="-1", aria-hidden="true")
      .modal-dialog.modal-xl.modal-dialog-centered(style="max-width:75vw;")
        .modal-content
          .modal-body
            .row
              .col-md-7
                h4#modalTitulo
                if modalImagem
                  img.img-fluid.mb-3(src=modalImagem, alt="Imagem da postagem")
                p#modalConteudo
                ul.list-group
                  li.list-group-item
                    b Categoria: 
                    span#modalCategoria
                  li.list-group-item
                    b Tags: 
                    span#modalTags
                  li.list-group-item
                    b Data de criação: 
                    span#modalData
                  li.list-group-item
                    b Tipo de postagem: 
                    span#modalTipo
                  li.list-group-item
                    b Artigo científico: 
                    span#modalArtigo
                  li.list-group-item
                    b Latitude: 
                    span#modalLat
                  li.list-group-item
                    b Longitude: 
                    span#modalLng
              .col-md-5
                h5 Comentários
                .comentarios-container(style="max-height:400px;overflow-y:auto;")
                  // Aqui renderize os comentários
                .mt-3
                  span.me-3
                    i.fas.fa-eye.me-1
                    | <span id="modalVisualizacoes"></span> Visualizações
                  span.me-3
                    i.fas.fa-heart.me-1
                    | <span id="modalCurtidas"></span> Curtidas
                  button.btn.btn-primary#btnCompartilhar(type="button") Compartilhar
                  button.btn.btn-outline-success#btnCurtir(type="button") Curtir
                  button.btn.btn-outline-secondary#btnComentar(type="button") Comentar
          .modal-footer.justify-content-end
            a#btnEditarPost.btn.btn-warning.btn-lg.d-flex.align-items-center(href="#")
              i.fas.fa-edit.fs-2.me-2
              .d-flex.flex-column.align-items-start
                span.fs-5 Editar Postagem
                small.text-warning-50 Altere o conteúdo desta postagem.

  block scripts
    script(src="/javascripts/index.js")
